##### Install Docker using Salt: #####

sudo salt 'SM*' cmd.run 'apt-get update'

sudo salt 'SM*' cmd.run 'apt-get install -y apt-transport-https'
sudo salt 'SM*' cmd.run 'apt-get install -y ca-certificates'
sudo salt 'SM*' cmd.run 'apt-get install -y curl'
sudo salt 'SM*' cmd.run 'apt-get install -y gnupg-agent'
sudo salt 'SM*' cmd.run 'apt-get install -y software-properties-common'


# Transfer gpg key:
## Save gpg key locally:
curl -fsSL https://download.docker.com/linux/ubuntu/gpg > ${TMP_LOCATION}
## Transfer local copy using Salt:
sudo salt-cp 'SM*' ${TMP_LOCATION} /tmp/docker.gpg


# Install Docker:
sudo salt 'SM*' cmd.run 'add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" '
sudo salt 'SM*' cmd.run 'apt-get install -y docker-ce docker-ce-cli containerd.io'


# Setup Docker Proxy:
## Create folder:
sudo salt 'SM*' cmd.run 'mkdir -p /etc/systemd/system/docker.service.d'

## Define proxy:
sudo salt 'SM*' cmd.run 'echo "[Service]\nEnvironment=\"HTTP_PROXY=170.140.138.165:8000\" " > /etc/systemd/system/docker.service.d/http-proxy.conf'

## Confirm proxy files:
sudo salt 'SM*' cmd.run 'cat /etc/systemd/system/docker.service.d/http-proxy.conf'

## Reload daemons:
sudo salt 'SM*' cmd.run 'systemctl daemon-reload && echo Hello'
sudo salt 'SM*' cmd.run 'systemctl restart docker && echo Hello'
sudo salt 'SM*' cmd.run 'systemctl show --property=Environment docker'

## Test Docker Proxy:
sudo salt 'SM*' cmd.run 'docker run hello-world'


##### Git clone using Salt: #####
sudo salt 'SM*' git.clone user=root cwd=/Github/Docker url=https://github.com/fgiuste7/Docker.git


##### Setup Monitoring using Salt: #####
# Use repository in /home/fgiuste
## Update Repository: (Run in single salt minion since /home is shared in all minions)
sudo salt 'SM1.maas' git.pull user=root cwd=/home/fgiuste/Github/Docker

# Start swarm:
sudo salt 'SM1.maas' cmd.run 'docker swarm init --advertise-addr=`hostname --ip-address`'

# Start Monitor stack:
sudo salt 'SM1.maas' cmd.run cwd=/home/fgiuste/Github/Docker/Monitoring 'docker stack deploy --compose-file monitoring.yaml monitor'





##### Bonus #####
# Install Docker for Python: (NOT required)
#sudo salt 'SM1*' pip.install pkgs=docker proxy=170.140.138.165:8000
#sudo salt 'SM1*' pip.install pkgs=docker-engine proxy=170.140.138.165:8000

# Get minions primary ip address:
sudo salt 'SM1.maas' cmd.run 'hostname --ip-address'
